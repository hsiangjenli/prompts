---
mode: agent
description: 依據 Red 階段的失敗測試進行實作，讓測試轉為綠燈並記錄過程
inputs:
  summary: 以本 Prompt 指導 Green 階段的實作與測試
  required:
    - 目標 TDD Issue 與最新測試矩陣（標示需轉綠的項目）
    - 對應的測試檔、失敗訊息與阻塞清單（來自 `tdd-red`）
    - 相關程式與合約位置（模組、API、資料處理、模型等）
    - CI/CD 或品質守門需求（Lint、型別檢查、靜態分析等）
    - 語言與輸出格式偏好（預設繁體中文 + Markdown）
outputs:
  summary: 記錄實作調整、測試結果與遇到的問題，將狀態更新為 Green
  include:
    - 實作重點與修改檔案摘要（含測試結果）
    - 連續錯誤追蹤表（欄位：`Test ID`、`測試檔/名稱`、`錯誤摘要(前120字)`、`錯誤分類`、`連續次數`、`已處理動作`、`來源/信賴等級`）；同一錯誤連續 3 次提醒透過 MCP 留言，若達 5 次需透過 MCP 將標籤調整為 `human_required` 並說明原因
    - 品質檢查項目（Lint、Type Check、依賴更新等）的執行紀錄與結果來源
    - 尚未解決的阻塞與建議下一步（Refactor 或 requirements-change）
---

# tdd-green

## 目的

根據 Red 階段製作的失敗測試，實作最小可行程式碼讓測試轉為綠燈，同時維持程式品質並記錄遇到的議題。

## 流程

### Phase 0：準備（重讀失敗測試）
1. 快速重讀失敗測試，確認目標行為與輸入輸出。
2. 檢查需修改的模組、依賴檔案與限制條件（效能、安全、資料規範等）。
3. 先更新或建立必要的 Mock / 測試資料；若資料缺口源於需求／契約差異，記錄並建議回到 `requirements-change` 或 `sdd`。

### Phase 1：執行（實作與測試）
1. 按照最小實作原則修改程式碼，保持一次只處理一個情境。
2. 每次修改後執行對應測試，紀錄結果與執行指令。
3. 依 README〈MCP 錯誤處理與回圈規則〉累計錯誤：若同一錯誤連續出現 3 次（定義：同一測試檔案與測試名稱出現相同錯誤訊息前 120 字），請先標記錯誤分類並透過 MCP 在 TDD Issue 留言：
   - 簡述錯誤訊息與重複次數
   - 紀錄已嘗試的解法或觀察
   - 提出下一步計畫或需要協助的地方（若判定為需求問題，註明需回到 `requirements-change`）
   留言需引用相關 Issue `#編號` 與信賴等級。若同一錯誤連續達 5 次，請同時透過 MCP 將 TDD Issue 標籤調整為 `human_required` 並在留言說明原因與建議的回圈。
4. 確保測試從 Red 轉為 Green 後再繼續下一個項目。

### Phase 2：記錄與交接（品質檢查）
1. 執行必要的守門檢查：Lint、型別檢查、靜態分析、依賴安全掃描等。
2. 將主要修改與測試結果摘要整理成段落或表格，附來源與信賴等級。
3. 更新 TDD Issue 測試矩陣的狀態為 Green，附上測試輸出連結或片段，標示來源（CI 執行、在地命令等）。
4. 如果仍有阻塞或未完事項，列出並指派在 Refactor 階段處理；若屬需求/契約差異，記錄需回到 `requirements-change` 或 `sdd`。
5. 提醒下一步執行 `tdd-refactor.prompt.md`，並在 TDD Issue 迭代進度中勾選 `Green` 核取框。

## 產出格式建議

- **變更摘要表**：檔案路徑、修改重點、對應情境、測試命令、來源與信賴等級。
- **測試結果**：成功測試的截圖或重點輸出、CI 執行 URL（附來源說明）。
- **錯誤追蹤**：若有留言，附上留言連結或內容摘要，標示是否建議回到 `requirements-change`。
- **待辦事項**：列出需在 Refactor 階段或 PR 中處理的項目，含責任人與預計完成時間。

## 後續建議

- 若 Green 階段遇到需求不一致，回到 BDD / SDD Issue 重新對齊。
- 完成後立即啟動 `tdd-refactor.prompt.md`，確保品質提升。
- 在輸出結尾提醒使用者確認已於 TDD Issue 留言或更新狀態，並同步紀錄來源與信賴等級。
