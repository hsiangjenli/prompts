---
mode: agent
description: 先理解需求並整理成 BDD 使用者故事與 Gherkin 情境，為後續 SDD --> TDD Prompt 提供完整輸入
inputs:
  summary: 使用 Prompt 釐清使用者需求
  required:
    - 直接對話進行釐清
    - 提供會議記錄、文件、`README.md`、GitHub Issue Number 等相關資訊
outputs:
  summary: 以使用者情境為主，整理可追蹤的需求摘要，準備交由 SDD/TDD 進一步展開（非技術實作細節）
  include:
    - 產出可直接貼入 `.github/ISSUE_TEMPLATE/bdd.yaml` 的 Issue 草稿（標題採 `[功能ID] - [功能名稱]` 格式）
    - 使用可用的 MCP / GitHub 工具直接建立 BDD Issue；若無權限才提供草稿
  - 列出使用者故事與 Gherkin 情境（僅含行為與情境，禁止加入技術、API、資料模型或實作細節）
    - 提供下一個建議 Prompt（預設 `sdd.prompt.md` 或 `tdd.prompt.md`；若出現技術議題，跳轉至 `tech-stack.prompt.md`）
---

# 需求分析（BDD 導向）

## 目的

以不斷提問的方式去釐清需求，並使用 BDD 使用者故事（User Story）與 Gherkin 語法整理需求，方便後續對齊 SDD --> TDD 的實作流程

## 提問原則

- 採「單一問題 + 選項 + 自訂輸入」格式，便於使用者快速回覆
- 每題最多 4 個選項，預留「⑤ 其他／自行輸入」

### 常用問題題庫

```
- 這個功能的主要使用者是誰？
  ① 一般使用者  ② 管理員  ③ 系統管理員  ④ 其他（請說明）
- 使用者想要達成什麼目標？
  （請具體描述使用者的需求或痛點）
- 使用者在什麼情境下會使用這個功能？
  （例如：登入後、查看資料時、收到通知時）
- 使用者期望看到什麼結果？
  （請描述成功的狀態或畫面）
- 如果操作失敗，使用者應該看到什麼？
  （例如：錯誤訊息、提示、替代方案）
- 這個功能有沒有前置條件？
  （例如：需要先登入、需要先完成某個步驟）
- 使用者可能會遇到哪些異常情況？
  ① 輸入格式錯誤  ② 權限不足  ③ 資料不存在  ④ 其他（請說明）
```

## 操作流程

### Step 1：確認狀態

1. 閱讀使用者提供的文件（如：`README.md`、`CHANGELOG.md`、GitHub Issue 等），了解近期變更與程式邏輯
2. 檢查是否已有 BDD 需求 Issue。若有，請根據原本的 Issue 進行修改

### Step 2：補齊需求

1. 發現需求的不一致、缺漏
2. 藉由不斷提問，釐清使用者的需求
3. **重要**：BDD 階段僅聚焦於使用者行為與業務需求，不應包含任何技術細節（API、資料模型、架構設計等）

### Step 2.5：分配功能 ID

**重要**：每個 BDD Issue 都必須被指派一個唯一的功能 ID，以便後續 SDD 和 TDD 進行追蹤。

1. **功能 ID 命名規範**：
   - 格式：`REQ-{序號}`（例如：`REQ-001`、`REQ-002`、`REQ-003`...）
   - 序號依據項目建立順序遞增
   - 功能 ID 在整個專案中全局唯一，不可重複

2. **避免重複的策略**：
   - 檢查已有的 BDD Issue，確認功能 ID 序號
   - 新 Issue 使用下一個未使用的序號
   - 若已刪除某個功能（例如 REQ-005），其序號不再使用（空缺不填補）

3. **填入 BDD Issue**：
   - 在建立 BDD Issue 時，務必填入「功能 ID」欄位
   - Title 格式：`[功能ID] - [功能名稱]`（例如 `REQ-001 - 使用者登入`）

### Step 3：整理輸出

1. 立即透過可用的 MCP / GitHub API 建立 BDD Issue（標題 `[功能ID]: [功能名稱]`；使用 `.github/ISSUE_TEMPLATE/bdd.yaml`）
2. 若因權限受限無法建立 Issue，則輸出完整草稿供手動貼上
3. 整理使用者故事與 Gherkin 場景，確保符合 BDD 語法
4. 在輸出中附上 Issue 連結或草稿，以及建議的下一個 Prompt

#### BDD Issue 格式參考

請參考 `.github/ISSUE_TEMPLATE/bdd.yaml` 中的欄位定義與範例：
- **標題格式**：`[功能ID] - [功能名稱]`（例如 `REQ-001 - 使用者登入`）
- **功能 ID**：唯一識別碼（例如：REQ-001）
- **使用者故事與行為測試**：包含使用者故事（作為...，我想要...，以便...）和 Gherkin 場景（Given-When-Then）
- **相關 SDD 與 TDD Issue**：使用表格列出每個 `US<序號>-S<序號>` Scenario 對應的 SDD/TDD Issue 編號或「待建立」，確保場景與後續工作保持一對一追蹤

## 後續行動

- 下一個預計執行的 Prompt（預設 `sdd.prompt.md` 或 `tdd.prompt.md`，視需求類型決定）
