---
mode: agent
description: 當需求在 BDD/SDD/TDD 階段進行中時發現需要變更，協助快速評估影響範圍、更新相關需求與設計文件，並同步所有受影響的 GitHub Issue
inputs:
  summary: 確認變更來源、現有 Issue 狀態與影響範圍
  required:
    - 變更來自何處（BDD Issue、SDD Issue、TDD Issue 或新的臨時需求）
    - 變更摘要（原因、期望成果、優先順序）
    - 已有的 BDD/SDD/TDD Issue 編號與目前狀態
  optional:
    - 相關文件、設計圖、程式碼片段
    - 時程或部署限制
outputs:
  summary: 提供變更影響分析與同步方案，直接更新相關 GitHub Issue
  include:
    - 變更影響範圍評估（哪些 BDD Scenario、SDD 契約、TDD 測試項會受影響）
    - 建議的更新順序（BDD → SDD → TDD）與需更新的 Issue 編號
    - 新增或修改的 User Story/Scenario/Test（使用 markdown 表格）
    - 直接透過 GitHub API 更新相關 Issue；若無權限則提供完整草稿
    - 下一步建議 Prompt（可能需回到 `requirements.prompt.md`、`sdd.prompt.md` 或 `tdd-requirements.prompt.md`）
---

# 需求變更管理（BDD/SDD/TDD 中途修正）

## 目的

當專案在 BDD、SDD 或 TDD 階段進行中時發現需要新增或修改需求，協助快速：
1. 評估變更對既有 Issue 與設計文件的影響
2. 確定需要回溯哪一層級進行調整（BDD → SDD → TDD）
3. 更新所有受影響的 GitHub Issue，避免文件不一致
4. 提供清晰的後續行動清單

## 前置條件

- 至少已有一個已建立的 BDD Issue（即使尚未批准）
- 能清楚說明變更的背景、觸發點（BDD/SDD/TDD 哪個階段發現）
- 對現有的 Issue 狀態、相關 PR/分支有基本了解

## 何時啟動此 Prompt

- ✅ **BDD 階段**：發現需要新增 User Story 或調整 Scenario
- ✅ **SDD 階段**：發現設計缺漏或契約需要調整（需回溯至 BDD 驗證）
- ✅ **TDD 階段**：測試執行時發現邏輯或驗收條件有誤（需回溯至 SDD 更新設計）
- ✅ **實作中**：代碼實作時才發現需求不清或設計不足（需全面評估影響）

## 提問原則

- 採「單一問題 + 選項 + 自訂輸入」格式，便於快速判定
- 每題最多 4 個選項，預留「⑤ 其他／自行輸入」

### 常用問題題庫

```
- 變更來自哪個階段的發現？
  ① BDD（需求本身不清）  ② SDD（設計有誤）  ③ TDD（測試無法進行）  ④ 其他（請說明）

- 這個變更是否影響現有的 User Story 或 Scenario？
  ① 新增新的 Scenario  ② 修改既有 Scenario  ③ 刪除某個 Scenario  ④ 其他（請說明）

- 是否需要調整系統設計或契約？
  ① 需要修改 API 介面  ② 需要新增資料欄位  ③ 需要調整驗證邏輯  ④ 其他（請說明）

- 變更是否影響已建立的 TDD 測試計畫？
  ① 需要新增測試場景  ② 需要修改測試場景  ③ 需要刪除測試場景  ④ 其他（請說明）

- 這個變更的優先順序是多少？
  ① P0（立即進行，阻塞當前工作）  ② P1（本週內完成）  ③ P2（可延後）  ④ 其他（請說明）

- 變更是否影響非功能需求或部署流程？
  ① 需要調整 CI/CD  ② 需要新增監控  ③ 不影響  ④ 其他（請說明）

- 您期望如何同步此變更？
  ① 直接更新相關 GitHub Issue  ② 產出變更摘要由我手動貼上  ③ 兩者都要  ④ 其他（請說明）
```

## 操作流程

### Step 1：判定變更層級與更新順序

1. **詢問變更來自何處**
   - 是在 BDD（需求層面）、SDD（設計層面）還是 TDD（測試層面）發現？
   - 根據發現位置決定更新順序：
     - **在 BDD 發現**：BDD → SDD → TDD（順向更新）
     - **在 SDD 發現**：SDD ← BDD（先回溯驗證）→ TDD（再更新下層）
     - **在 TDD 發現**：TDD ← SDD ← BDD（全面回溯驗證）→ SDD → TDD（依序更新）
   
2. **確認現有 Issue 狀態**
   - 讀取相關的 BDD/SDD/TDD Issue（若有）
   - 檢查是否存在相關的 PR、分支或已實作代碼
   - 確認受影響的 Scenario ID（例如 US1-S1、US1-S2）

3. **明確更新與確認流程**
   - 按照上述順序，**逐一更新各層級 Issue**
   - **每更新一個 Issue 後，向使用者確認內容無誤**
   - 確認無誤後，再進行下一層級的更新
   - 確保全流程有完整的人工審視，避免誤更新

### Step 2：評估變更影響

1. **逐層分析影響**
   - **BDD 層**：哪些 User Story 或 Scenario 受影響？需新增、修改還是刪除？
   - **SDD 層**：相應的設計、契約、資料模型是否需要調整？
   - **TDD 層**：測試矩陣、測試場景、驗收條件是否需要更新？

2. **蒐集必要資訊**
   - 若信息不足，透過問答補齊（使用上方「常用問題題庫」）
   - 標記待確認項目為 🟡（黃色 - 待確認）或 🔴（紅色 - 需人工決策）

### Step 3：建立變更方案

1. **整理變更清單**（使用 Markdown 表格）
   - 受影響的層級（BDD / SDD / TDD）
   - 原有內容
   - 新增或修改後的內容
   - 涉及的 Issue 編號

2. **標記更新順序**
   - BDD Issue（優先）→ SDD Issue（次優先）→ TDD Issue（最後）
   - 每個 Issue 標記為「更新 #編號」或「新建」

### Step 4：執行同步（逐層更新 + 確認）

**重要**：按照 Step 1 決定的更新順序，逐一更新各層級 Issue，每次更新後都要求使用者確認。

1. **第一層 Issue 更新**
   - 根據變更清單更新第一層 Issue 內容（可透過 GitHub API 或提供 Markdown 草稿）
   - 生成更新摘要，清晰展示新增/修改的內容
   - **要求使用者確認**：「以上 Issue #X 的變更內容是否正確？」
   - 只有在使用者確認後，才進行下一層級的更新

2. **第二層 Issue 更新（若需要）**
   - 使用者確認第一層後，執行第二層 Issue 的更新
   - 同樣生成更新摘要並要求確認
   - 確認無誤後進行第三層更新

3. **第三層 Issue 更新（若需要）**
   - 同上流程，更新第三層 Issue 並要求最終確認

4. **同步 Comment 與關聯**
   - 所有 Issue 確認無誤後，在各 Issue 的 Comment 中互相引用
   - 確保三層 Issue 之間的 Sub-Issue 關聯保持一致
   - 標記變更完成時間與版本信息

### Step 5：確認與後續

1. **輸出變更確認表**
   - 列出所有已更新的 Issue（編號與連結）
   - 列出待人工確認的項目（🟡／🔴）
   - 建議下一步 Prompt（例如：若 BDD 調整，需執行 `requirements.prompt.md` 再回到此流程）

2. **提醒同步通知**
   - 在各相關 Issue 的 Comment 中互相引用，確保团队成員可追蹤完整脈絡

## 注意事項

- **不自行決策**：若信息不足，直接向使用者追問；不得自行臆測變更內容
- **完整追蹤**：引用 GitHub Issue 時一律使用 `#編號` 格式，並在相關 Issue 評論中互相引用
- **待確認標註**：對於推測或需確認的項目，使用 🟡（待確認）/ 🔴（需決策）標註
- **避免重複**：變更同步後，檢查是否產生重複或衝突的 Scenario/測試項
- **時程考慮**：根據優先順序（P0/P1/P2）決定是否立即進行或排入後續計畫
