---
mode: agent
description: 透過問答方式釐清系統設計與契約需求，將 BDD 使用者故事轉為具體的技術規範與介面設計
inputs:
  summary: 使用 Prompt 透過互動式問答釐清系統設計
  required:
    - 直接對話進行釐清
    - 提供 BDD Issue 編號（選填，若已有）、設計文件、架構圖、現有契約文件等相關資訊
outputs:
  summary: 以技術規範為主，整理可追蹤的系統設計摘要，準備交由 TDD 進一步展開
  include:
    - 產出可直接貼入 `.github/ISSUE_TEMPLATE/sdd.yaml` 的 Issue 草稿（標題採 `SDD: <規範名稱>` 格式）
    - 使用可用的 MCP / GitHub 工具直接建立 SDD Issue；若無權限才提供草稿
    - 列出契約設計、介面規範、資料模型（包含驗證方式與 Mock 策略）
    - 提供下一個建議 Prompt（預設 `tdd-requirements.prompt.md`）
---

# 系統設計分析（SDD 導向）

## 目的

以不斷提問的方式釐清系統設計需求，並將 BDD 使用者故事轉換為具體的技術規範、介面契約與資料模型，方便後續 TDD 實作。

## 前置條件

- **重要**：對應的 BDD Issue 必須已被加上 `approved` label。若 BDD Issue 尚未批准，請拒絕進行 SDD 問答，並建議使用者先完成 BDD 審核
- 建議先完成 BDD Issue（或至少有明確的使用者故事），若無則透過問答補齊
- 若需求有變動，應先回到 BDD 更新後再進行 SDD

## 提問原則

- 採「單一問題 + 選項 + 自訂輸入」格式，便於使用者快速回覆
- 每題最多 4 個選項，預留「⑤ 其他／自行輸入」

### 常用問題題庫

```
- 這個功能涉及哪些子系統或元件？
  ① API 介面  ② 資料庫  ③ 前端 UI  ④ 其他（請說明）
  
- 這個功能需要什麼類型的介面契約？
  ① REST API  ② GraphQL  ③ 事件訊息（Event）  ④ 其他（請說明）
  
- API 的輸入參數有哪些？
  （請列出參數名稱、類型、是否必填、驗證規則）
  
- API 的回應格式是什麼？
  （請說明成功回應的欄位與格式，包含狀態碼）
  
- 如果 API 呼叫失敗，應該回傳什麼錯誤訊息？
  ① 標準錯誤碼 + 訊息  ② 自訂錯誤格式  ③ 沿用現有格式  ④ 其他（請說明）
  
- 這個功能需要哪些資料欄位？
  （請列出欄位名稱、類型、長度限制、預設值）
  
- 資料需要什麼驗證規則？
  ① 格式驗證（Email、電話等）  ② 範圍驗證（最小/最大值）  ③ 必填檢查  ④ 其他（請說明）
  
- 是否需要 Mock 資料進行測試？
  ① 需要（請說明 Mock 資料情境）  ② 不需要  ③ 使用現有測試資料  ④ 其他（請說明）
  
- 這個設計需要符合哪些規範或標準？
  ① GDPR  ② WCAG 2.1  ③ ISO 27001  ④ 其他（請說明）
  
- 受影響的元件或功能有哪些？
  （例如：使用者註冊、會員資料儲存、權限檢查）
  
- 如何驗證這個設計是否正確實作？
  ① 自動化測試  ② 手動檢查  ③ 第三方驗證工具  ④ 其他（請說明）
```

## 操作流程

### Step 1：確認狀態

1. **檢查 BDD Issue 批准狀態**：確認對應的 BDD Issue 是否已被加上 `approved` label
   - 若 BDD Issue 未被批准，拒絕進行 SDD 問答，並提醒使用者「請先將 BDD Issue 加上 `approved` label 後再呼叫本 Prompt」
   - 若 BDD Issue 已被批准，繼續進行
2. 閱讀使用者提供的文件（如：BDD Issue、設計文件、架構圖、現有契約等），了解業務需求與技術脈絡
3. 檢查是否已有 SDD Issue。若有，請根據原本的 Issue 進行修改

### Step 2：補齊設計

1. 發現設計的不一致、缺漏或技術可行性問題
2. 藉由不斷提問，釐清系統設計需求：
   - 介面契約（API、事件、資料格式）
   - 資料模型（欄位、類型、驗證規則）
   - 規範要求（GDPR、WCAG、ISO 等）
   - Mock 資料策略
3. **重要**：SDD 階段聚焦於技術規範與介面設計，不涉及具體實作細節（程式語言、框架選擇等留給 TDD）

### Step 3：整理輸出

1. 立即透過可用的 MCP / GitHub API 建立 SDD Issue（標題 `SDD: <規範名稱>`；使用 `.github/ISSUE_TEMPLATE/sdd.yaml`）
2. 若因權限受限無法建立 Issue，則輸出完整草稿供手動貼上
3. 整理契約對照表、Mock 策略、驗證方式，確保符合 SDD 格式
3. **重要**：SDD Issue 建立完成後，由 AI Agent 回到原本的 BDD Issue，在「相關 SDD 與 TDD Issue」欄位中新增 SDD Issue 編號（例如：`SDD: #2`）
4. 在輸出中附上 Issue 連結或草稿，以及建議的下一個 Prompt

#### SDD Issue 格式參考

請參考 `.github/ISSUE_TEMPLATE/sdd.yaml` 中的欄位定義與範例：
- **對應 BDD Issue**：記錄此 SDD 依據的 BDD Issue 編號（格式為 `#123`）
- **規範或標準名稱**：說明相關規範（例如：GDPR、WCAG 2.1、ISO 27001）
- **要求描述**：詳細描述此規範的具體要求
- **受影響的元件或功能**：列出會影響到的元件或功能
- **驗證方式**：說明如何驗證此規範是否已實現
- **對應 BDD Scenario**：列出本 SDD 涵蓋的 BDD Scenario ID 與行為摘要
- **其他相關 Issue**：若此 SDD 與其他 Issue（如技術債、Bug）有關，請列出編號

## 後續行動

- 下一個預計執行的 Prompt（預設 `tdd-requirements.prompt.md`，準備進入測試階段）
- 若設計過程中發現需求問題，建議回到 `requirements.prompt.md` 更新 BDD Issue
